
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Opportunities Table — Demo</title>
  <link rel="stylesheet" href="./opportunity-table.css"/>
  <style>
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;padding:16px;}
    .row{display:flex;gap:10px;align-items:center;margin-bottom:8px;}
    .mini{color:#64748b;font-size:12px}
    input,select{padding:6px 8px;border:1px solid #cbd5e1;border-radius:6px}
    button{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}
    button.primary{background:#1e6091;color:#fff;border-color:#1e6091}
    .log{white-space:pre-wrap;background:#0b1020;color:#e5e7eb;padding:8px;border-radius:8px;height:160px;overflow:auto}
  </style>
</head>
<body>
  <h1>Opportunities Table — Demo</h1>
  <p class="mini">This page mounts the module with a tiny in-page Event Bus and sample data.</p>

  <div class="row">
    <label>Search <input id="q" placeholder="text"/></label>
    <label>Client <input id="client" placeholder="client name"/></label>
    <label>Sales step 
      <select id="step">
        <option value="">(all)</option>
        <option>Discovery</option><option>Qualified</option>
        <option>Solution selling</option><option>Negotiation</option>
        <option>Closing</option><option>Won</option><option>Lost</option>
      </select>
    </label>
    <label>Close from <input type="date" id="from"/></label>
    <label>to <input type="date" id="to"/></label>
    <button id="apply">Apply</button>
    <button id="clear">Clear</button>
  </div>

  <div id="mount"></div>

  <h3>Event log</h3>
  <div id="log" class="log"></div>

  <script>
    // Tiny Event Bus for the demo
    const bus = (function(){
      const map = new Map();
      function on(topic, handler){
        if(!map.has(topic)) map.set(topic, new Set());
        const set = map.get(topic); set.add(handler);
        return () => set.delete(handler);
      }
      function emit(topic, payload){
        const now = new Date().toISOString();
        log(`[${now}] ${topic} ${JSON.stringify(payload||{})}`);
        const set = map.get(topic);
        if(set){ set.forEach(h => { try{ h(payload); }catch(e){ console.error(e); } }); }
      }
      function log(s){ const pre = document.getElementById('log'); pre.textContent += (pre.textContent?'\n':'')+s; pre.scrollTop = pre.scrollHeight; }
      return { on, emit, _log:log };
    })();
    window.bus = bus;
  </script>

  <script src="./opportunity-table.js"></script>
  <script>
    // Sample resolvers and data
    const companies = { "C-1": "Maello", "C-2": "Globex", "C-3": "Initech" };
    const contacts  = { 
      "CT-1": { firstName:"Marc", lastName:"Le Guyader", companyId:"C-1" },
      "CT-2": { firstName:"John", lastName:"Doe", companyId:"C-2" },
      "CT-3": { firstName:"Alice", lastName:"Martin", companyId:"C-3" },
    };
    function resolveCompanyName(id){ return companies[id]; }
    function resolveContactName(id){ const c = contacts[id]; if(!c) return ''; return `${c.firstName||''} ${c.lastName||''}`.trim(); }

    const rows = [
      { id:"OPP-000001", name:"Migration CRM", salesStep:"Discovery", client:"ResQuant", owner:"Marc", companyId:"C-1", contactId:"CT-1", notes:"", nextAction:"Call back", nextActionDate:"2025-10-10", closingDate:"2025-12-01", closingValue:12000 },
      { id:"OPP-000002", name:"Support Pack", salesStep:"Qualified", client:"Aico", owner:"Sam", companyId:"C-2", contactId:"CT-2", notes:"NDA signed", nextAction:"Send quote", nextActionDate:"2025-10-08", closingDate:"2025-11-15", closingValue:4500 },
      { id:"OPP-000003", name:"Integration", salesStep:"Negotiation", client:"eShard", owner:"Sven", companyId:"C-3", contactId:"CT-3", notes:"Pilot running", nextAction:"Demo v2", nextActionDate:"2025-10-12", closingDate:"2025-12-31", closingValue:22000 }
    ];

    // Mount module
    const mountEl = document.getElementById('mount');
    const table = OpportunityTable.mount(mountEl, bus, { resolveCompanyName, resolveContactName, currency:'EUR' });

    // Seed data
    bus.emit('data.loaded', { rows });

    // Filter controls
    document.getElementById('apply').addEventListener('click', ()=>{
      bus.emit('filters.changed', {
        q: document.getElementById('q').value || undefined,
        client: document.getElementById('client').value || undefined,
        salesStep: document.getElementById('step').value || undefined,
        closeDate: {
          from: document.getElementById('from').value || undefined,
          to: document.getElementById('to').value || undefined
        }
      });
    });
    document.getElementById('clear').addEventListener('click', ()=> bus.emit('filters.cleared'));

    // Listen to dialog open events (just to show they fire)
    bus.on('dialogs.open.opportunity', p => bus._log('→ (demo) would open opportunity dialog for id='+ (p && p.id)));
    bus.on('dialogs.open.company', p => bus._log('→ (demo) would open company dialog for companyId='+ (p && p.companyId)));
    bus.on('dialogs.open.contact', p => bus._log('→ (demo) would open contact dialog for contactId='+ (p && p.contactId)));
  </script>
</body>
</html>
