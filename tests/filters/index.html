<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Filters Module — Tests</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <main>
    <h1>Filters Module — Tests</h1>
    <p>Open the console to see assertions. Results also appear below.</p>
    <div id="fixture"></div>
    <pre id="out"></pre>
  </main>

  <script type="module">
    const out = document.getElementById('out');
    const log = (msg) => { out.textContent += msg + "\n"; console.log(msg); };

    // Tiny Bus for tests
    const bus = (()=>{
      const map = new Map();
      return {
        on(t,h){ if(!map.has(t)) map.set(t,new Set()); map.get(t).add(h); return ()=>map.get(t)?.delete(h); },
        emit(t,p){ (map.get(t)||[]).forEach(h=>{ try{h(p);}catch(e){console.error(e)} }); },
      };
    })();

    import { createFiltersModule } from '../../modules/filters/filters.js';
    const { mount } = createFiltersModule(bus);

    const container = document.getElementById('fixture');
    const api = mount(container, { q:'abc', client:'Acme', closeDate:{from:'2025-01-01'}, salesStep:'Qualified' });

    // Collect events
    const events = [];
    ['filters.changed','filters.cleared','filters.toggled'].forEach(t => bus.on(t, p => events.push({ t, p })));

    // Test 1: toggle via ui.banner.filter must open, then close
    bus.emit('ui.banner.filter');
    bus.emit('ui.banner.filter');
    log('Test1: toggled twice');

    // Test 2: Apply emits filters.changed with current values
    container.querySelector('#flt-apply').click();
    log('Test2: apply clicked');

    // Test 3: Clear emits filters.cleared and resets get()
    container.querySelector('#flt-clear').click();
    const after = api.get();
    log('Test3: clear clicked; get()=' + JSON.stringify(after));

    // Assertions (basic)
    const hasToggled = events.some(e => e.t==='filters.toggled');
    const hasChanged = events.some(e => e.t==='filters.changed');
    const hasCleared = events.some(e => e.t==='filters.cleared');

    log('Assert toggled: ' + (hasToggled ? 'OK' : 'FAIL'));
    log('Assert changed: ' + (hasChanged ? 'OK' : 'FAIL'));
    log('Assert cleared: ' + (hasCleared ? 'OK' : 'FAIL'));
  </script>
</body>
</html>
