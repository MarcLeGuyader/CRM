<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Event Bus — Manual & Auto Tests</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="card">
    <h1>Event Bus <span class="badge" id="count">0 listeners</span></h1>
    <p>Click buttons to emit UI topics. See the log below. This page also runs a few automated assertions.</p>
    <div class="row">
      <button data-topic="ui.banner.filter">Filter</button>
      <button data-topic="ui.banner.new">+ New</button>
      <button data-topic="ui.banner.debug">🐞 Debug</button>
      <button data-topic="ui.banner.reset">⟲ Reset</button>
      <button data-topic="ui.banner.upload">Upload</button>
      <button data-topic="ui.banner.export">Export</button>
      <button data-topic="ui.banner.save">Save</button>
      <button id="btn-clear">Clear listeners (test only)</button>
    </div>
    <pre id="log"></pre>
  </div>

  <script type="module">
    import { bus } from '../../modules/event-bus/bus.js';
    import './test.js';

    const logEl = document.getElementById('log');
    const countEl = document.getElementById('count');

    function log(topic, payload){
      const line = `[${new Date().toISOString()}] ${topic} ${JSON.stringify(payload)}`;
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // Example listeners for all banner buttons
    const topics = [
      'ui.banner.filter','ui.banner.new','ui.banner.debug','ui.banner.reset',
      'ui.banner.upload','ui.banner.export','ui.banner.save'
    ];
    const offs = topics.map(t => bus.on(t, p => log(t, p)));

    // Wire buttons to emit events
    document.querySelectorAll('button[data-topic]').forEach(btn => {
      btn.addEventListener('click', () => {
        const topic = btn.getAttribute('data-topic');
        bus.emit(topic, { ts: Date.now() });
      });
    });

    // Clear listeners button (for demonstration/test)
    document.getElementById('btn-clear').addEventListener('click', () => {
      offs.forEach(off => off());
      bus.clear(); // test/dev only
      log('INFO', 'Cleared all listeners');
      refreshCount();
    });

    function refreshCount(){ countEl.textContent = `${bus.count()} listeners`; }
    refreshCount();

    // Keep count updated on subscribe/unsubscribe in this page
    const origOn = bus.on;
    bus.on = function(...args){
      const off = origOn.apply(bus, args);
      refreshCount();
      return () => { off(); refreshCount(); };
    };
  </script>
</body>
</html>
