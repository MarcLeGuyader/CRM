<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Modular App</title>

  <!-- Global styles -->
  <link rel="stylesheet" href="./styles/main.css" />

  <!-- Optional local module CSS -->
  <link rel="stylesheet" href="./modules/filters/filters.css" />
</head>

<body>
  <div id="app">
    <header id="banner"></header>
    <section id="filters"></section>
    <main id="table"></main>
    <footer id="debug"></footer>
  </div>

  <script type="module">
    // === 1. Import modules ===
    import { bus } from './modules/event-bus/bus.js';
    import { mount as mountBanner } from './modules/top-banner/top-banner.js';
    import { mount as mountDebug } from './modules/debug-console/debug-console.js';
    import { createFiltersModule } from './modules/filters/filters.js';

    // === 2. Make bus globally visible for debugging ===
    window.bus = bus;

    // === 3. Mount Debug Console ===
    const debugApi = mountDebug(document.getElementById('debug'), bus);
    window.debug = debugApi;

    // === 4. Mount Top Banner ===
    const bannerApi = mountBanner(document.getElementById('banner'), bus);
    window.banner = bannerApi;

    // === 5. Mount Filter Console ===
    const { mount: mountFilters } = createFiltersModule(bus);
    const filtersApi = mountFilters(
      document.getElementById('filters'),
      {
        q: '',           // free-text search
        client: '',      // client name or partial
        closeDate: {},   // { from:'YYYY-MM-DD', to:'YYYY-MM-DD' }
        salesStep: ''    // sales stage (empty = all)
      }
    );
    window.filters = filtersApi;

    // === 6. Temporary glue: log banner events to debug console ===
    const topics = [
      'ui.banner.filter','ui.banner.new','ui.banner.debug',
      'ui.banner.reset','ui.banner.upload','ui.banner.export','ui.banner.save'
    ];
    for (const t of topics) {
      bus.on(t, payload => {
        debugApi.log(`[${t}]`, payload);
      });
    }

    console.log('[CRM] Application initialized.');
  </script>
</body>
</html>
